// ============================================
// NUEVA SECCI√ìN DE NOTIFICACIONES OPTIMIZADA
// Reemplaza desde l√≠nea 173 hasta l√≠nea 1444
// ============================================

  // ========== FUNCIONES PARA NOTIFICACIONES (NUEVO SISTEMA) ==========
  
  const handleAgregarNotificacion = () => {
    setNotificacionEditar(null);
    setModalNotificacion(true);
  };

  const handleEditarNotificacion = (notif: NotificacionData, index: number) => {
    setNotificacionEditar({ data: notif, index });
    setModalNotificacion(true);
  };

  const handleGuardarNotificacion = (notifData: NotificacionData) => {
    if (notificacionEditar !== null) {
      // Editar existente
      setFormData(prev => ({
        ...prev,
        notificaciones: prev.notificaciones?.map((n, i) => 
          i === notificacionEditar.index ? notifData as any : n
        )
      }));
    } else {
      // Agregar nueva
      setFormData(prev => ({
        ...prev,
        notificaciones: [...(prev.notificaciones || []), notifData as any]
      }));
    }
    
    setModalNotificacion(false);
    setNotificacionEditar(null);
  };

  const handleEliminarNotificacion = (index: number) => {
    setFormData(prev => ({
      ...prev,
      notificaciones: prev.notificaciones?.filter((_, i) => i !== index)
    }));
  };

  const handleToggleActivaNotificacion = (index: number) => {
    setFormData(prev => ({
      ...prev,
      notificaciones: prev.notificaciones?.map((n, i) => 
        i === index ? { ...n, activa: !n.activa } : n
      )
    }));
  };

  const handleEnviarPruebaNotificacion = async (index: number) => {
    const notif = formData.notificaciones?.[index];
    if (!notif) return;

    try {
      const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';
      const token = localStorage.getItem('auth_token');

      const response = await fetch(`${API_BASE_URL}/api/modules/calendar/notificaciones/enviar-prueba`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          empresaId,
          notificacion: notif
        })
      });

      if (response.ok) {
        alert('‚úÖ Notificaci√≥n de prueba enviada correctamente');
      } else {
        const error = await response.json();
        alert(`‚ùå Error: ${error.message || 'No se pudo enviar la notificaci√≥n'}`);
      }
    } catch (error) {
      console.error('Error al enviar prueba:', error);
      alert('‚ùå Error al enviar la notificaci√≥n de prueba');
    }
  };

// ========== JSX DE LA SECCI√ìN (Reemplaza desde l√≠nea 739 hasta 1444) ==========

        {/* SECCI√ìN NOTIFICACIONES */}
        {seccionActiva === 'notificaciones' && (
          <div className={styles.seccion}>
            <div className={styles.seccionHeader}>
              <h2>üîî Notificaciones Autom√°ticas</h2>
              <button
                type="button"
                onClick={handleAgregarNotificacion}
                className={styles.btnAgregar}
              >
                + Nueva Notificaci√≥n
              </button>
            </div>

            <div className={styles.infoBox}>
              <h4>üì± ¬øQu√© son las notificaciones autom√°ticas?</h4>
              <p>
                Env√≠a mensajes de WhatsApp autom√°ticos a tus clientes y agentes seg√∫n el momento que configures.
              </p>
              <ul>
                <li><strong>Confirmaciones:</strong> Solicita confirmaci√≥n de asistencia</li>
                <li><strong>Recordatorios:</strong> Avisa sobre turnos pr√≥ximos</li>
                <li><strong>Agendas:</strong> Env√≠a lista de turnos del d√≠a a los agentes</li>
              </ul>
              <p style={{ marginTop: '0.5rem', fontSize: '0.9rem', color: '#666' }}>
                üí° <strong>Variables disponibles:</strong> {'{cliente}'}, {'{agente}'}, {'{fecha}'}, {'{hora}'}, {'{origen}'}, {'{destino}'}, {'{pasajeros}'}, {'{telefono}'}
              </p>
            </div>

            <ListaNotificaciones
              notificaciones={(formData.notificaciones || []) as NotificacionData[]}
              onEditar={handleEditarNotificacion}
              onEliminar={handleEliminarNotificacion}
              onToggleActiva={handleToggleActivaNotificacion}
              onEnviarPrueba={handleEnviarPruebaNotificacion}
            />
          </div>
        )}

// ========== MODAL (Reemplaza l√≠neas 1463-1487) ==========

      {/* Modal de Notificaci√≥n */}
      <ModalNotificacion
        isOpen={modalNotificacion}
        onClose={() => {
          setModalNotificacion(false);
          setNotificacionEditar(null);
        }}
        onSubmit={handleGuardarNotificacion}
        notificacionInicial={notificacionEditar?.data || null}
        agentes={agentes}
        clientes={clientes}
      />
